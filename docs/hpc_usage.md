# HPC usage

This file contains instructions for login, configuring, and using the university HPC servers to train DL models using GPUs.
More information about the HPC server is available here: https://hpcwiki.tue.nl/wiki/Main_Page

## Log into server
Connect via ssh

```ssh [username]@hpc.win.tue.nl```

## Load Anaconda
The server contains a list of modules available for usage. In our experiments, we want to use anaconda to create and manage virtual environments. The commands below can be used to load the anaconda module.

See what modules are loaded in the current session

```module list```

See the available modules that can be loaded

```module avail```

Load the anaconda module

```module load anaconda/[version]```


## Create virtual environment
Once the anaconda module is loaded, we can create a virtual environment with the following steps.

Create virtual environment for a specific Python version (3.7)

``` conda create -n [env-name] python=3.7```

Verify that the virtual enviroment was created

``` conda info --envs ```

Activate the virtual environment

``` conda activate [env-name] ```

Optional, check the Python version inside the virtual environment

## Install libraries
With a virtual environment activated, we can install the libraries required for our project.

First, add conda-forge channel to anaaconda in order to install libraries supported by the Python community, but not by anaconda

``` conda config --append channels conda-forge ```

Verify that conda-forge was added to the channels

``` conda config -- show channels ```

Install the libraries in requirements.txt

``` conda install --file requirements.txt ```

In case some libraries need to be installed manually, execute

``` conda install [library-name] ```

*Note:* this library name corresponds to the one recognized by anaconda, which is not necessarily the same used pip.

## Execute Python scripts using GPUs

1) First create a bash script to run your Python script. In case the Python script receives configuration values from the command line, include these parameters in the bash script as well. The example below (```run_python_script.sh```) shows a batch script that executes a Python script requiring command line arguments.

```
#!/usr/bin/bash

#SBATCH --partition=mcs.gpu.q
#SBATCH --output=retrained_results.out

python python_script.py [param1] [param2] ... [paramn]
```

Contents of the script:
* ``` mcs.gpu.q ``` indicates that we want to use a gpu during training.
* ```retrained_results.out``` is the log file that will contain the messages generated by Python script, which are usually shown in the command line.
* ``` python_script.py ``` is the name of the Python script to execute.
* The values between brackets (```[]```) are the parameters that the Python script receives from the command line.


2) Then, execute the script as follows

``` sbatch run_python_script.sh```

3) Next, see the status of your script

``` squeue -u $(whoami)```

4) Finally, monitor the progress of your script

``` tail -f results.out ```
